# Lab 3: (Optional) Setup SonarQube and Scan Application Code

In this lab, you will set up the open-source SonarQube platform using Docker and Docker Compose. You will then manually scan a Java application, analyze the scan report, and understand common issues such as vulnerabilities, code smells, and bugs.

***

### Learning Objectives

1. Install and run SonarQube using Docker and Docker Compose
2. Perform a manual code scan of a Java application
3. Understand the results produced by SonarQube, including code quality metrics and security findings

***

### Prerequisites

* A Linux virtual machine with Docker and Docker Compose installed
* Port 9000 must be open on the VM
* Ability to install packages and run commands
* Follow Docker installation steps from the official documentation

To allow Docker commands without sudo, run:

```bash
sudo usermod -aG docker $USER
newgrp docker
```

***

## Step-by-Step Guide

### Step 1: Set Up SonarQube Server

1. Connect to the Linux virtual machine.
2. Clone the SonarQube setup repository (public repo provided by your instructor).

Example:

```bash
git clone <sonarqube-repo-url>
cd <repository-folder>
```

3. Inside the repository, you will find a docker-compose.yml file that defines the full SonarQube service including its database.
4. Start SonarQube using:

```bash
docker compose up -d
```

This will download images and start both SonarQube and its internal database.

5. Open your web browser and navigate to:

```
http://<vm-ip-address>:9000
```

Ensure port 9000 is allowed in VM security rules.

6. Login with default credentials:

* Username: admin
* Password: admin

You will be prompted to change the password. Set a new password of your choice.

You should now see the SonarQube welcome dashboard.

***

### Step 2: Create a New Project for Manual Code Scanning

1. In SonarQube, click **Create a project** or **Create a local project**.
2. Fill in the required fields:
   * Project Display Name: Sample Java Project
   * Project Key: auto-filled by SonarQube
   * Branch: main
3. Click **Next**.
4. Select **Use global settings** when asked about analysis method.
5. Click **Create Project**.
6. SonarQube will show instructions for manual setup. Select the **Maven** option.
7. Copy the generated Maven command. It will look similar to the following:

```
mvn clean verify sonar:sonar \
  -Dsonar.projectKey=ecommerce-java-project \
  -Dsonar.projectName="ecommerce java project" \
  -Dsonar.host.url=http://localhost:9000 \
  -Dsonar.token=<your-token>
```

Save this command for later.

***

### Step 3: Prepare the Java Application for Scanning

1. Clone the Java project you want to scan.

Example:

```bash
git clone <ecommerce-java-repo-url>
cd <project-folder>
```

2. Ensure Java and Maven are installed on your VM. If not, install Maven:

```bash
sudo apt update
sudo apt install maven -y
```

Verify Maven installation:

```bash
mvn -version
```

***

### Step 4: Scan the Java Application

1. Navigate into the Java application directory.
2. Run the Maven SonarQube scan command you copied earlier.

Important: Replace `<your-token>` with the token generated by SonarQube.

Example:

```bash
mvn clean verify sonar:sonar \
  -Dsonar.projectKey=ecommerce-java-project \
  -Dsonar.projectName="ecommerce java project" \
  -Dsonar.host.url=http://localhost:9000 \
  -Dsonar.token=abc123xyz456
```

3. The build and scan will take a few minutes. Once complete, return to the SonarQube dashboard.

***

### Step 5: Explore SonarQube Analysis Results

1. Open your SonarQube UI at:

```
http://<vm-ip-address>:9000
```

2. Select the scanned project from the list.
3. Review the following key metrics:

#### Bugs

Coding errors that may break functionality.

#### Vulnerabilities

Security concerns that can lead to exploits or unauthorized access.

#### Code Smells

Maintainability issues and poor coding practices.

#### Coverage

Percentage of code covered by unit tests.

#### Duplications

Percentage of code that is duplicated.

4. Navigate through the code issues to understand:

* Description of each problem
* Severity
* Affected file and line number
* Suggested fix or remediation guidance

***

### Step 6: Validate Successful Scan

If the project appears on the SonarQube dashboard with analysis results, your SonarQube setup and scan were successful.

***

### Completion

You have successfully:

1. Set up SonarQube using Docker and Docker Compose
2. Configured and created a project for code scanning
3. Scanned a Java application using Maven
4. Viewed and interpreted code quality reports

You now know how to use SonarQube to analyze code quality, enforce standards, and detect vulnerabilities.
